# Exploring of game sale dataset

This is a video game sales data including game sales of North America, Euroupean, Japan and other area, together they make the global sale. The data also give the information about the critic score, user score and the number of critics or users who gave these two scores. This data is downloaded from [https://www.kaggle.com/rush4ratio/video-game-sales-with-ratings#Video_Games_Sales_as_at_22_Dec_2016.csv](https://www.kaggle.com/rush4ratio/video-game-sales-with-ratings#Video_Games_Sales_as_at_22_Dec_2016.csv). 

The detail about the data is listed as follow:

Name: Name of the game

Platform: Console on which the game is running

Year_of_Release: Year of the game released

Genre: Game's category

Publisher: Publisher

NA_Sales: Game sales in North America (in millions of units)

EU_Sales: Game sales in the European Union (in millions of units)

JP_Sales: Game sales in Japan (in millions of units)

Other_Sales: Game sales in the rest of the world, i.e. Africa, Asia excluding Japan, Australia, Europe excluding the E.U. and South America (in millions of units)

Global_Sales: Total sales in the world (in millions of units)

Critic_Score: Aggregate score compiled by Meta critic staff

Critic_Count: The number of critics used in coming up with the Critic_score

User_Score: Score by Metacritic's subscribers

User_Count: Number of users who gave the user_score

Developer: Party responsible for creating the game

Rating: The ESRB ratings: 
E for "Everyone"; E10+ for "Everyone 10+"; T for "Teen"; M for "Mature"; AO for "Adults Only"; RP for "Rating Pending". 

After downloading the data, We replace N/A with NA first in excel and save it as csv file and read in. We remove these observations with empty string of Rating and 6825 observations was left in our data. 

##Reading in data and manage data
```{r}
tem <- read.csv("datasets/video-game-sales-at-22-Dec-2016.csv")
#tem <- read.csv("datasets/video-game-sales.csv")
game <- na.omit(tem)  #remove NA

library(dplyr)
game <- game %>% filter(Rating != "") %>% droplevels()  #remove empty rating observations

#by multiplying 1000000 we get the actual sale, 
#adding 1 makes all sales positive which make log possible for all sales later
game$Year_of_Release <- as.factor(as.character(game$Year_of_Release))
game$NA_Sales <- game$NA_Sales * 1000000 + 1
game$EU_Sales <- game$EU_Sales * 1000000 + 1
game$JP_Sales <- game$JP_Sales * 1000000 + 1
game$Other_Sales <- game$Other_Sales * 1000000 + 1
game$Global_Sales <- game$Global_Sales * 1000000 + 1

# By divide by 10 to make Critic Score the same decimal as User Score
game$Critic_Score <- as.numeric(as.character(game$Critic_Score)) / 10  
game$User_Score <- as.numeric(as.character(game$User_Score))
game$Critic_Count <- as.numeric(game$Critic_Count)
game$User_Count <- as.numeric(game$User_Count)
colnames(game) <- c("Name", "Platform", "Year.Release", "Genre", "Publisher", "NA.Sales", "EU.Sales", "JP.Sales", "Other.Sales", "Global.Sales", "Critic.Score", "Critic.Count", "User.Score", "User.Count", "Developer", "Rating")
head(game)
str(game)
summary(game)
```

```{r}
Year.Release <- game$Year.Release 
Critic.Score <- game$Critic.Score 
Critic.Count <- game$Critic.Count 
User.Score <- game$User.Score   
User.Count <- game$User.Count  
```

Summary of these variables tell us that some of the games was published several times in the same name; PS2 is the most popular platform; Action is the most popular Genre; Electronic Arts has the most high frequency among the publishers; Rating T and E are the two most released ratings; For these sales, though the minimums, several quantiles and medians are small, but the maximums are high, which means there are special cases in sales; Maximum User count is extreme big. 

```{r message=FALSE, fig.width=8, fig.height=8}
a <- colnames(game)[c(6:14)]  # pick up the numeric columns according to the names 
par(mfrow = c(3, 3))  # layout in 3 rows and 3 columns
for (i in 1:length(a)){
  sub <- sample(game[a[i]][, 1], 5000)
  hist(sub, main = paste("Hist. of", a[i], sep = " "), xlab = a[i])
 }
```

```{r}
NA.Sales.Log <- log(game$NA.Sales)   
EU.Sales.Log <- log(game$EU.Sales)  
JP.Sales.Log <- log(game$JP.Sales)   
Other.Sales.Log <- log(game$Other.Sales)  
Global.Sales.Log <- log(game$Global.Sales) 
Critic.Count.Log <- log(game$Critic.Count)
User.Count.Log <- log(game$User.Count)
```

We combine the log variables with the original variables.
```{r}
game.log <- cbind.data.frame(NA.Sales.Log, EU.Sales.Log, JP.Sales.Log, Other.Sales.Log,
Global.Sales.Log, Critic.Count.Log, User.Count.Log)
game <- cbind.data.frame(game, game.log)  # the data we use for analysis
head(game)
str(game)
```

```{r message=FALSE, fig.width=8, fig.height=10}
a <- colnames(game)[c(11, 13, 17:23)]  # pick up the numeric columns according to the names 
par(mfrow = c(5, 4))  # layout in 5 rows and 4 columns
for (i in 1:length(a)){
  sub <- sample(game[a[i]][, 1], 5000)
  submean <- mean(sub)
  hist(sub, main = paste("Hist. of", a[i], sep = " "), xlab = a[i])
  abline(v = submean, col = "blue", lwd = 1)
  qqnorm(sub, main = paste("Q-Q Plot of", a[i], sep = " "))
  qqline(sub) 
  if (i == 1) {s.t <- shapiro.test(sub)
  } else {s.t <- rbind(s.t, shapiro.test(sub))
 }
}
s.t <- s.t[, 1:2]
mode(s.t) = "numeric"  # show shapiro.test result as numeric
s.t <- round(data.frame(s.t), 3)  # round to decimal 3
s.t$data.name <- a
s.t
```

Though the Shapiro test still deny the normality of these log values. We assume they are normal distributed data after log-transformation. 

There are lots of interest points in this data set such as the distribution of global and regional sales and their relationship, the correlation of critic score and user score and their counts, whether these scores are the main effect for sales, or the other factors like genre, rating, platform, even publisher affect the sales more, and so on.

## Visualizing of categorical variables
```{r warning=FALSE, message=FALSE}
library(wordcloud)
library(ngram)
library(tm)
library(RColorBrewer)
titles <- concatenate(game$Name)
titles <- tolower(titles)
titles <- removeNumbers(titles)
titles <- removePunctuation(titles)
titles <- stripWhitespace(titles)
titles <- removeWords(titles, c(stopwords("en"), "game"))
unigram <- ngram(titles, n = 1)
freq <- tbl_df(get.phrasetable(unigram))
wordcloud(freq$ngrams, freq$freq, random.order = FALSE, rot.per = 0.35,
          color=brewer.pal(8, "Dark2"), max.words = 500)
```

The most common word in game name is world and ii, then star, wars and NBA. Soccer, NFL, dragon, Lego and warriors are the third popular team.  

```{r}
counts <- sort(table(game$Platform), decreasing = TRUE)
percentages <- 100 * counts / length(game$Platform)
barplot(percentages[1:18], las = 3, ylab = "Percentage", col = "green", axis.lty = 1)
```

These are the top 18 platforms according to the frequency. PSs occupies big portion.
```{r}
#regroup platform as Platform.type 
pc <- c("PC")
xbox <- c("X360", "XB", "XOne")
nintendo <- c("Wii", "WiiU", "N64", "GC", "NES", "3DS", "DS") 
playstation <- c("PS", "PS2", "PS3", "PS4", "PSP", "PSV")
game <- game %>%
  mutate(Platform.type = ifelse(Platform %in% pc, "pc",
                           ifelse(Platform %in% xbox, "xbox",
                             ifelse(Platform %in% nintendo, "nintendo", 
                               ifelse(Platform %in% playstation, "playstation", "others"))))) 
```

```{r }
library(ggplot2)
ggplot(game, aes(x = Platform.type)) + geom_bar(fill = "blue")
```

```{r}
dat <- data.frame(table(game$Genre))
dat$fraction = dat$Freq / sum(dat$Freq)
dat = dat[order(dat$fraction), ]
dat$ymax = cumsum(dat$fraction)
dat$ymin = c(0, head(dat$ymax, n = -1))
names(dat)[1] <- "Genre"
library(ggplot2)
ggplot(dat, aes(fill = dat$Genre, ymax = ymax, ymin = ymin, xmax = 4, xmin = 3)) +
geom_rect(colour = "grey30") + # background color
coord_polar(theta = "y") + # coordinate system to polar
xlim(c(0, 4)) +
labs(title = "Ring plot for Genre type", fill = "Genre") +
theme(plot.title = element_text(hjust = 0.5))
```

Action, Sports and Shooter are the first three biggest genre. Action occupies almost 25% genre. Three of
them together contribute half of genre count.

```{r}
#regroup Genre as Genre.type
genre <- c("Platform", "Racing", "Simulation", "Sports", "Misc")
#Combat <- c("fighting", "Shooter")

game <- game %>%
  mutate(Genre.type = ifelse(Genre %in% genre, as.character(Genre),
                        ifelse(Genre == "Fighting" | Genre == "Shooter", "Combat",
                          ifelse(Genre == "Puzzle" | Genre == "Strategy", "Strategy",
                                      "Action/Adventure"))))
```

```{r}
#regroup Rating as Rating.type 
rating <- c("E", "T", "M", "E10+")
game <- game %>% mutate(Rating.type = ifelse(Rating %in% rating, as.character(Rating), "Others")) 
```

```{r}
counts <- sort(table(game$Rating.type), decreasing = TRUE)
names(counts)[1] <- "T - Teen"  # rename the names of counts for detail information
names(counts)[2] <- "E - Everyone"
names(counts)[3] <- "M - Mature"
names(counts)[4] <- "E10+ - Everyone 10+"
pct <- paste(round(counts/sum(counts) * 100), "%", sep = " ")
lbls <- paste(names(counts), "\n", pct, sep = " ")  # labels with count number
pie(counts, labels = lbls, col = rainbow(length(lbls)),
main="Pie Chart of Ratings with sample sizes")
15
```

According to the order, the most popular ratings are T, E, M and E10+. There are altogether 6722 in 6825
games belong to these four ratings. Other ratings only occupy very little in the all games.

## Correlation among numeric variables
```{r fig.width=8, fig.height=8}
st <- game[, c(11, 13, 17:23)]  # take numeric variables as goal matrix
st <- na.omit(st)
library(ellipse)  # install.packages("ellipses")
library(corrplot)
corMatrix <- cor(as.matrix(st))  # correlation matrix
col <- colorRampPalette(c("#7F0000", "red", "#FF7F00", "yellow", "#7FFF7F",
                           "cyan", "#007FFF", "blue", "#00007F"))
corrplot.mixed(corMatrix, order = "AOE", lower = "number", lower.col = "black", 
               number.cex = .8, upper = "ellipse",  upper.col = col(10), 
               diag = "u", tl.pos = "lt", tl.col = "black")
```

There are high r values of 0.75, 0.65, 0.52 and 0.42 between the log value of Global.Sales and regional sales,
we will consider to use Global.Sales.Log as our target sales to analyze the relationship with other variables
later. On the other hand, there are good positive correlation between regional sales too. User Score is positive
correlated to Critic Score with r of 0.58. There is little correlation between User Count log value and User
Score. 
```{r}
plot(hclust(as.dist(1 - cor(as.matrix(st)))))  # hierarchical clustering
```

All sales’ log value except JP.Sales.Log build one cluster, scores build second cluster, and log value of counts
and JP.Sales build another one. In sales cluster, Other.Sales.Log is the closest to Global.Sales.Log, then
NA.Sales.Log, and EU.Sales.Log is the next.

## Analysis of Score and Count

### Distribution of two scores
```{r}
library(ggplot2)
ggplot() + 
  geom_density(data = game, aes(x=Critic.Score), color = "darkblue", fill = "lightblue") + 
  geom_density(data = game, aes(x=User.Score), color = "darkgreen", fill = "lightgreen", alpha=.5) +
  labs(x = "Critic.Score-blue, User.Score-green", title = "Density plot for critic and user score")
```



```{r message=FALSE, warning=FALSE}
ggplot(game, aes(x = Year.Release, y = Critic.Score, colour = "CriticScore")) + 
  geom_point(size = 3, alpha = 1.0) +  # scatter point of critic score
  geom_point(aes(y = User.Score, colour = "UserScore")) +  # scatter point of user score
  stat_summary(aes(y = Critic.Score, group = 1), fun.y = mean,   #add average critic score line
               colour = "red", geom = "line", size = 1.5, group = 1) +
  stat_summary(aes(y = User.Score, group = 1), fun.y = mean,  #add average critic score line
               colour = "green", geom = "line", size = 1.5, group = 1) +
  stat_summary(aes(y = Critic.Score, group = 1), fun.y = mean,  #add average critic score point
               colour = "white", geom = "point", size = 2, group = 1) +  
  stat_summary(aes(y = User.Score, group = 1), fun.y = mean,  #add average user score point
               colour = "yellow", geom = "point", size = 2, group = 1) + 
  theme(legend.position = "right",
          axis.text.x = element_text(angle = 90),
          panel.background = element_rect(fill = "blue"),  #background
          panel.grid.major = element_blank(),  #no panel grid
          panel.grid.minor = element_blank()) +
   labs(title = "Score distribution of Each Year", x = "Year Release", y = "Scores") +
   theme(plot.title = element_text(hjust = 0.5))
```

There is not so many evaluation about the game available before 1996. In the early years, averages of Critic.Score are higher than averages of User.Score. From 1998 Users gave higher score then critics on average, the situation kept until 2009. From 2010 till 2016, the trend of early years came back, average critic scores are higher than average user score again. 

Between 1996 and 1999, both critics and users intended to give higher scores than the other years.

```{r message=FALSE, warning=FALSE}
library(ggpmisc)  #package for function stat_poly_eq
formula <- y ~ x
ggplot(game, aes(x = User.Score, y = Critic.Score)) + 
  geom_point(aes(color = Platform), alpha = .8) + 
  geom_smooth(method = 'lm', se = FALSE, formula = formula) +  #add regression line
  theme(legend.position = "bottom") +
  stat_poly_eq(formula = formula,   #add regression equation and R square value
               eq.with.lhs = "italic(hat(y))~`=`~",  # add ^ on y
               aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
               label.x.npc = "left", label.y.npc = 0.92,   # position of the equation label
               parse = TRUE)   
```

There is good correlation between Critic.Score and User.Score. Some of the GBA games got highest User.Score, while highest Critic.Score came from X360 and PS series.

```{r}
t.test(game$Critic.Score, game$User.Score)
```

T-test with p value of much less than 0.05 let us accept the alternative hypothesis with 95% confidence that there is difference in the means of critic score and user score. The mean of critic score is 7.03, and mean of user score is 7.19.

### Score & Top sale game
```{r }
game$Name <- gsub("Brain Age: Train Your Brain in Minutes a Day",  #shorten the game name
                    "Brain Age: Train Your Brain", game$Name)
p1 <- game %>% 
  select(Name, User.Score, Critic.Score, Global.Sales) %>%
  group_by(Name) %>%
  summarise(Total.Sales = sum(Global.Sales), Avg.User.Score = mean(User.Score), 
            Avg.Critic.Score = mean(Critic.Score)) %>%
  arrange(desc(Total.Sales)) %>%
  head(20)
ggplot(p1, aes(x = factor(Name, levels = Name))) +
  geom_bar(aes(y = Total.Sales/10000000), stat = "identity", fill = "green") +
  geom_line(aes(y = Avg.User.Score, group = 1, colour = "Avg.User.Score"), size = 1.5) +
  geom_point( aes(y = Avg.User.Score), size = 3, shape = 21, fill = "Yellow" ) +
  geom_line(aes(y = Avg.Critic.Score,  group = 1, colour = "Avg.Critic.Score"), size = 1.5) +
  geom_point(aes(y = Avg.Critic.Score), size = 3, shape = 21, fill = "white") + 
  theme(axis.text.x = element_text(angle = 90, size = 8)) +
  ggtitle("Top Global Sales Game with Score" ) +  # add title in the center of the plot
  theme(plot.title = element_text(hjust = 0.5)) 
```

Among these 20 top sale games, top two games, Wii Sports and Grand Theft Auto V have much better sales than the other games. Both of them were scored above 7.5. Grand Theft Auto V even got the highest Critic score among all these top games. Though there are several other games like Grand Theft Auto IV, The Elder Scrolls V: Skyrim have really high scores too. This plot also indicates that for these top games, their global sales have no clear linear correlation with the average User.Score and Critic.Score. For most games, average critic score is higher than average user score. Call of Duty: Modern Warfare 3 and Call of Duty: Ghosts got really lower average user score comparing with other top sales game.

### Score & Rating
```{r }
summary(aov(game$Critic.Score ~ game$Rating))
summary(aov(game$User.Score ~ game$Rating))
```

There is significant difference in at least two different ratings for both critic score and user score means.
```{r warning=FALSE,  message=FALSE, fig.width=12, fig.height=3}
p1 <- ggplot(game, aes(x = Critic.Score, fill = Rating)) +
  geom_density(alpha = 0.3) 
p2 <- ggplot(game, aes(x = User.Score, fill = Rating)) +
  geom_density(alpha = 0.3) 
library(gridExtra)
grid.arrange(p1, p2, nrow = 1,ncol = 2)
```

In total, Rating M got more higher Critic.Score than others, E10+ got more lower Critic.Score; 
For User.Score, as same as Critic.Score, E10+ is low. While the others are similar and higher.

### 7) Score & Genre

```{r}
library(scales)
game %>% 
 group_by(Genre, Critic.Score) %>%
 summarise(Total.Sales = sum(Global.Sales)) %>%
 arrange(desc(Total.Sales)) %>%
 ggplot(aes(x = Critic.Score, y = Total.Sales, group = Genre, fill = Genre)) +
   geom_bar(stat = "identity", position = "fill", alpha = 0.7) +
   scale_y_continuous(labels = percent_format()) +
   theme(legend.position = "right", axis.text.x = element_text(angle = 90), 
        panel.background = element_rect(fill = "black"), 
        panel.grid.major = element_blank(),  
        panel.grid.minor=element_blank())
```

Some Racing and Adventure game got the lowest Critic.Score. On the other side, some action game got excellent evaluation from critics and have great Global.Sales. Sports, Shooter and Platform came next.

### 8) Score & Global sales
```{r warning=FALSE, message=FALSE, fig.width=12, fig.height=4}
p1 <- ggplot(game, aes(x = Critic.Score, y = Global.Sales.Log)) + 
  geom_point(aes(color = Genre)) + 
  geom_smooth()
p2 <- ggplot(game, aes(x = User.Score, y = Global.Sales.Log)) + 
  geom_point(aes(color = Rating)) + 
  geom_smooth()
grid.arrange(p1, p2, nrow = 1,ncol = 2)
```

Independent from Genre and Rating, the higher of Score, the better of Global.Sales.Log. Especially for Critic.Score bigger than 9, Global.Sales straight rising. Global.Sales rise slowly with User.Score.

```{r}
game.bottom <- select(filter(game, Critic.Score < 2.5), c(Global.Sales.Log, Critic.Score))
game.low <- select(filter(game, Critic.Score >= 2.5 & Critic.Score < 5), 
                   c(Global.Sales.Log, Critic.Score))
game.middle <- select(filter(game, Critic.Score >= 5 & Critic.Score < 7.5), 
                   c(Global.Sales.Log, Critic.Score))
game.high <- select(filter(game, Critic.Score >= 7.5 & Critic.Score < 9), 
                   c(Global.Sales.Log, Critic.Score))
game.top <- select(filter(game, Critic.Score >= 9), c(Global.Sales.Log, Critic.Score))
formula <- y ~ x
p1 <- ggplot(game.bottom, aes(x = Critic.Score, y = Global.Sales.Log)) + 
   geom_point() + geom_smooth()
p2 <- ggplot(game.low, aes(x = Critic.Score, y = Global.Sales.Log)) + 
   geom_point() + geom_smooth()
p3 <- ggplot(game.middle, aes(x = Critic.Score, y = Global.Sales.Log)) + 
  geom_point() + geom_smooth()
grid.arrange(p1, p2, p3, ncol = 3)
```

```{r}
r1 <- round(with(game.high, cor(Critic.Score, Global.Sales.Log)), digits = 2)
p4 <- ggplot(game.high, aes(x = Critic.Score, y = Global.Sales.Log)) + 
  geom_point() + geom_smooth() +
  stat_poly_eq(formula = formula, #add regression equation and R square value
    eq.with.lhs = "italic(hat(y))~`=`~", # add ^ on y
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    label.x.npc = "left", label.y.npc = 0.92, # position of the equation label
    parse = TRUE) +
  geom_text(x = 7.62, y = 17.2, label = paste("r =", r1, sep = " ")) # add correlation rate r
r2 <- round(with(game.top, cor(Critic.Score, Global.Sales.Log)), digits = 2)
p5 <- ggplot(game.top, aes(x = Critic.Score, y = Global.Sales.Log)) + 
  geom_point() + geom_smooth() +
  stat_poly_eq(formula = formula, #add regression equation and R square value
    eq.with.lhs = "italic(hat(y))~`=`~", # add ^ on y
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    label.x.npc = "right", label.y.npc = 0.1, # position of the equation label
    parse = TRUE)+
  geom_text(x = 9.5, y = 9.5, label = paste("r =", r2, sep = " ")) # add correlation rate r
grid.arrange(p4, p5, ncol = 2)
#ggarrange(p4, p5, ncol = 2)
```

If we seperate the citic score into 5 groups: bottom(<2.5), low(between2.5 & 5), middle(between 5 & 7.5), high(between 7.5 & 9) and top(>=9), there is no linear relationship between Global.Sales.Log and Critic.Score in the first three groups. For "high" group, correlation r is 0.22 and the linear equation of critic score can only explain about 0.05 global sales log; While for "top" group, correlation r is higher as 0.35 and the linear equation of critic score can only explain more  global sales log up to 0.13.

### 9) Score & Top Sale Developer 
```{r fig.width=10, fig.height=4}
library(reshape2)
p <- game %>% 
  select(Developer, Critic.Score, User.Score, Global.Sales) %>%
  group_by(Developer) %>%
  summarise(Avg.Critic.Score = mean(Critic.Score), Avg.User.Score = mean(User.Score), 
            Total.Sales = sum(Global.Sales/4/10^7)) %>% 
  filter(Total.Sales > 1) 
#arrange according to sales, melt only developer and scores
p1 <- p[, -4]
p1 <- melt(p1, value.name = "Scores")
p2 <- p[, 4]
comp <- cbind.data.frame(p1, p2)
comp <- comp[rev(order(comp$Total.Sales)), ]
lv <- unique(comp[1])
ggplot(comp, aes(x = factor(Developer, levels = as.factor(lv[,1])))) +
  geom_bar(aes(y = Scores, fill = variable), stat = "identity", width = .5, position = "dodge") +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Top sale Developers and their Scores", x = "Top Developers") +
  theme(plot.title = element_text(hjust = 0.5)) + 
  geom_line(aes(y = Total.Sales, group = 1), col = "navyblue", size = 1) 
```

According to our analysis, Nintendo is the only one which has total sales over 400 millions, much more than the other developers. The other top developers included EA Sports, EA Canada, Rockstar North, Capcorm and so on. This is a little bitter different order from the top developers according to number of games. But EA Sports, EA Canada and Capcorm are included in the top five in both list. Naughty Dogs has the highest user score, while Rockstar North got highest critic score. Infinity Ward got pretty good critic score, but user gave it a lowest score. Best sale developer Nintendo have pretty good scores, but not the highest in both scores.

### 10) Score & Publisher
```{r}
p1 <- game %>% 
  select(Publisher, Critic.Score, User.Score) %>%
  group_by(Publisher) %>%
  summarise(Avg.Critic.Score = mean(Critic.Score), Avg.User.Score = mean(User.Score)) %>% 
  filter( !Avg.Critic.Score =='NA' & !Avg.User.Score =='NA' & Avg.Critic.Score > 8) %>%
  arrange(desc(Avg.Critic.Score))
ggplot(p1, aes(x = factor(Publisher, levels = Publisher))) +
  geom_line(aes(y = Avg.User.Score, group = 1, colour = "Avg.User.Score"), size = 1.5) +
  geom_point( aes(y = Avg.User.Score), size = 3, shape = 21, fill = "yellow" ) +
  geom_line(aes(y = Avg.Critic.Score,  group = 1, colour = "Avg.Critic.Score"), size = 1.5) +
  geom_point(aes(y = Avg.Critic.Score), size = 3, shape = 21, fill = "white") + 
  theme(axis.text.x = element_text(angle = 90, size = 8)) +
  labs(title = "Top Publishers with Average Critic Score greater than 8", x = "Top Publisher" )
```

These are the top publisher who got highest average critic score. Valve, Valve Software and Blue Byte are the top three publisher who got the highest average critic score. For Activision Blizzard and Slightly Mad Studios, though they got relatively higher average critic score, but their average user score are not ideal. While for Kadokawa Shoten, Nihon Falcom Corporation and Sony Computer Entertainment Europe, they got even much higher average user score than average critic score.

## Analysis of Sales
### 1) By Year.Release
```{r fig.width=8, fig.height=8}
counts <- data.frame(table(game$Year.Release))
p <- game %>%
  select(Year.Release, Global.Sales) %>%
  group_by(Year.Release) %>%
  summarise(Total.Sales = sum(Global.Sales))
q <- cbind.data.frame(p, counts[2])
names(q)[3] <- "count"
q$count <- as.numeric(q$count)

p1 <- ggplot(q, aes(x = Year.Release, y = Total.Sales, label = q$count)) +
  geom_col(fill = "green") +
  geom_point(y = q$count * 500000, size = 3, shape = 21, fill = "Yellow" ) +
  geom_text(y = (q$count - 30) * 500000) +  # position of the text: count of games each year
  theme(axis.text.x = element_text(angle = 90),
        panel.background = element_rect(fill = "purple"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  scale_x_discrete("Year.Release", labels = as.character(Year.Release), breaks = Year.Release)
  labs(title = "Global Sales Each Year", x = "Year Release", y = "Global Sales")

r <- round(with(q, cor(count, Total.Sales)), digits = 2)
formula <- y ~ x    
library(ggpmisc)
p2 <- ggplot(q, aes(x = count, y = Total.Sales)) + 
   geom_point() +
   geom_smooth() +
   stat_poly_eq(formula = formula,   #add regression equation and R square value
               eq.with.lhs = "italic(hat(y))~`=`~",  # add ^ on y
               aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
               label.x.npc = "left", label.y.npc = 0.92,   # position of the equation label
               parse = TRUE) +
  geom_text(x = 25, y = 410000000, label = paste("r =", r, sep = " ")) # add correlation rate r
grid.arrange(p1, p2, ncol = 1, nrow = 2)
```

We can notice from the histogram of total sales that there is very little sales before 1996. There is only one game was released for these years. For several years between 1996 and 2000 the sales increased slowly. The count of games too, from 7 to 30. After that there is a big climbing in total sales. Over 100 games were released each year after that. The top sales happened in 2008, and the most count games was released that year(592). After that total sales of the video games sloped down. And the count of games reduced too. 
There is a good correlation between total sales and the count of game sold with r=0.96. If we use the equation top left in the figure, we can explain 0.92 of the total sales.

### 2) By Region
```{r fig.width=8, fig.height=4}
game %>%
  select(Year.Release, NA.Sales.Log, EU.Sales.Log, JP.Sales.Log, 
         Other.Sales.Log, Global.Sales.Log) %>%
  group_by(Year.Release) %>%
  summarise(NorthAmerica = sum(NA.Sales.Log), Europe = sum(EU.Sales.Log), 
            Japan = sum(JP.Sales.Log), Other = sum(Other.Sales.Log), 
            Global = sum(Global.Sales.Log)) %>%
  ggplot(aes(x = Year.Release, y = NorthAmerica,  colour="NorthAmerica")) + 
    geom_point() +  
    geom_line(group = 1) +
    geom_point(aes(y = Europe, colour = "Europe")) +
    geom_line(aes(y = Europe, colour = "Europe", group = 1)) +
    geom_point(aes(y = Japan, colour = "Japan")) +
    geom_line(aes(y = Japan, colour = "Japan", group = 1)) +
    geom_point(aes(y = Other, colour = "Other")) +
    geom_line(aes(y = Other, colour = "Other", group = 1)) +
    geom_point(aes(y = Global, colour = "Global")) +
    geom_line(aes(y = Global, colour = "Global", group = 1)) +
    theme(legend.position = "bottom",
          axis.text.x = element_text(angle = 90),
          panel.background = element_rect(fill="pink"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank()) +
    scale_x_discrete("Year.Release", labels = as.character(Year.Release), 
                     breaks = Year.Release) +
    labs(title = "Regional Global Sales Log Distribution Each Year", 
         x = "Year Release", y = "Total Sales Log Value") +
    theme(plot.title = element_text(hjust = 0.5))
```

The pattern of log value for these regional sales in those years are similar for Global, North America, Europe, and Others. Japan is much different from them. Same conclusion as cluster analysis.

### 3) By Genre
```{r }
game %>% 
  select(Year.Release, Global.Sales.Log, Genre) %>%
  group_by(Year.Release, Genre) %>%
  summarise(Total.Sales.Log = sum(Global.Sales.Log)) %>%
  ggplot(aes(x = Year.Release, y = Total.Sales.Log, group = Genre, fill = Genre)) +
         geom_area() +
         theme(legend.position = "right", axis.text.x = element_text(angle = 90),
               panel.background = element_rect(fill = "blue"),
               panel.grid.major = element_blank(),
               panel.grid.minor=element_blank()) +
         scale_x_discrete("Year.Release", labels = as.character(Year.Release), 
                          breaks = Year.Release)+
         labs(title = "Year Wise Log Global Sales by Genre") + 
         theme(plot.title = element_text(hjust = 0.5)) 
```

In total the golden years are from 2007 to 2009 for most of these Genres. Action keeps on the top sale for all those years. Strategy is on the bottom sale list. 

```{r fig.width=12, fig.height=4}
library(scales )
 # reorder according to the length per Genre, to make the plots look beautiful and keep axis y stable 
game$Genre. <- with(game, reorder(Genre, Genre, function(x) -length(x))) 
P0 <- game %>%
  select(Genre., Global.Sales) %>%
  group_by(Genre.) %>%
  summarise(GlobalSales = sum(Global.Sales)) %>%
  arrange(desc(GlobalSales)) %>%
  mutate(p.GlobalSales = GlobalSales/sum(GlobalSales) * 100) %>%  #percentage in total Sales
  arrange(desc(p.GlobalSales)) %>%
ggplot(aes(x = Genre., y = p.GlobalSales)) +
  geom_col(fill = "purple", alpha = 0.8) +
  coord_flip()
P1 <- game %>%
  select(Genre., NA.Sales) %>%
  group_by(Genre.) %>%
  summarise(NASales = sum(NA.Sales)) %>%
  arrange(desc(NASales)) %>%
  mutate(p.NASales = NASales / sum(NASales) * 100) %>%
  arrange(desc(p.NASales)) %>%
ggplot(aes(x = Genre., y = p.NASales)) +
  geom_col(fill = "red", alpha = 0.8) +
  coord_flip() +
  theme(axis.title.y = element_blank(), axis.text.y = element_blank())  
P2 <- game %>%
  select(Genre.,EU.Sales) %>%
  group_by(Genre.) %>%
  summarise(EUSales = sum(EU.Sales)) %>%
  arrange(desc(EUSales)) %>%
  mutate(p.EUSales = EUSales / sum(EUSales) * 100) %>%
  arrange(desc(p.EUSales)) %>%
ggplot(aes(x = Genre., y = p.EUSales)) +
  geom_col(fill = "yellow", alpha = 0.8) +
  coord_flip() + 
  theme(axis.title.y = element_blank(), axis.text.y = element_blank())
P3 <- game %>%
  select(Genre., JP.Sales) %>%
  group_by(Genre.) %>%
  summarise(JPSales = sum(JP.Sales)) %>%
  arrange(desc(JPSales)) %>%
  mutate(p.JPSales = JPSales / sum(JPSales) * 100) %>%
  arrange(desc(p.JPSales)) %>%
ggplot(aes(x = Genre., y = p.JPSales)) +
  geom_col(fill = "blue", alpha = 0.8) +
  coord_flip() +
  theme(axis.title.y = element_blank(), axis.text.y = element_blank())
P4 <- game %>%
  select(Genre., Other.Sales) %>%
  group_by(Genre.) %>%
  summarise(OtherSales = sum(Other.Sales)) %>%
  arrange(desc(OtherSales)) %>%
  mutate(p.OtherSales = OtherSales / sum(OtherSales) * 100) %>%
  arrange(desc(p.OtherSales)) %>%
ggplot(aes(x = Genre., y = p.OtherSales)) +
  geom_col(fill = "green", alpha = 0.8) +
  coord_flip()+
  theme(axis.title.y = element_blank(), axis.text.y = element_blank())
library(ggpubr)
library(magrittr)
ggarrange(P0, P1, P2, P3, P4, ncol = 5, nrow = 1, widths = c(1.3, 1, 1, 1, 1)) 
```

Generally North America, Europe Sales and other sales follow the global Sales pattern. They all have Action, Sports and Shooter as top 3 genres, Puzzle, Adventure and Strategy as bottom 3 genres. Japan market is different from them. The Role-Playing gets the largest portion in Japan sales, while Shooter plays much less portion comparing with the other regions. Platform and Puzzle are popular in Japan than in other regions. As other regions, action and sports are still the most popular Genre in Japan. 

### 4) By Rating
```{r }
game %>% 
  select(Year.Release, Global.Sales, Rating) %>%
  group_by(Year.Release, Rating) %>%
  summarise(Total.Sales = sum(Global.Sales)) %>%
ggplot(aes(x = Year.Release, y = Total.Sales, group = Rating, fill = Rating)) +
  geom_area() +
  theme(legend.position = "right", axis.text.x = element_text(angle = 90),
        panel.background = element_rect(fill = "green"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_x_discrete("Year.Release", labels = as.character(Year.Release), breaks = Year.Release) +
  labs(title = "Year Wise Global Sales by Rating") +
  theme(plot.title = element_text(hjust = 0.5)) +
  coord_flip()
```

Rating E and E10+ run the first two in global sales. Compare with E, E10+, M and T, the other rating sales were so little and even not show in our area figure. 2008 is a good year for all ratings.
```{r echo=FALSE, fig.width=12, fig.height=4}
library(scales )
 # reorder according to the length per Rating, to make the plots look beautiful and keep axis y stable 
game$Rating. <- with(game, reorder(Rating, Rating, function(x) -length(x))) 
P0 <- game %>%
  select(Rating., Global.Sales) %>%
  group_by(Rating.) %>%
  summarise(GlobalSales = sum(Global.Sales)) %>%
  arrange(desc(GlobalSales)) %>%
  mutate(p.GlobalSales = GlobalSales / sum(GlobalSales) * 100) %>%  #get percentage in total Sales
  arrange(desc(p.GlobalSales)) %>%
ggplot(aes(x = Rating., y = p.GlobalSales)) +
  geom_col(fill = "purple", alpha = 0.8) +
  coord_flip()
P1 <- game %>%
  select(Rating., NA.Sales) %>%
  group_by(Rating.) %>%
  summarise(NASales = sum(NA.Sales)) %>%
  arrange(desc(NASales)) %>%
  mutate(p.NASales = NASales / sum(NASales) * 100) %>%
  arrange(desc(p.NASales)) %>%
ggplot(aes(x = Rating., y = p.NASales)) +
  geom_col(fill = "red", alpha = 0.8) +
  coord_flip() +
  theme(axis.title.y = element_blank(), axis.text.y = element_blank())  
P2 <- game %>%
  select(Rating.,EU.Sales) %>%
  group_by(Rating.) %>%
  summarise(EUSales = sum(EU.Sales)) %>%
  arrange(desc(EUSales)) %>%
  mutate(p.EUSales = EUSales / sum(EUSales) * 100) %>%
  arrange(desc(p.EUSales)) %>%
ggplot(aes(x = Rating., y = p.EUSales)) +
  geom_col(fill = "yellow", alpha = 0.8) +
  coord_flip() + 
  theme(axis.title.y = element_blank(), axis.text.y = element_blank())
P3 <- game %>%
  select(Rating., JP.Sales) %>%
  group_by(Rating.) %>%
  summarise(JPSales = sum(JP.Sales)) %>%
  arrange(desc(JPSales)) %>%
  mutate(p.JPSales = JPSales / sum(JPSales) * 100) %>%
  arrange(desc(p.JPSales)) %>%
ggplot(aes(x = Rating., y = p.JPSales)) +
  geom_col(fill = "blue", alpha = 0.8) +
  coord_flip() +
  theme(axis.title.y = element_blank(), axis.text.y = element_blank())
P4 <- game %>%
  select(Rating., Other.Sales) %>%
  group_by(Rating.) %>%
  summarise(OtherSales = sum(Other.Sales)) %>%
  arrange(desc(OtherSales)) %>%
  mutate(p.OtherSales = OtherSales / sum(OtherSales) * 100) %>%
  arrange(desc(p.OtherSales)) %>%
ggplot(aes(x = Rating., y = p.OtherSales)) +
  geom_col(fill = "green", alpha = 0.8) +
  coord_flip()+
  theme(axis.title.y = element_blank(), axis.text.y = element_blank())
ggarrange(P0, P1, P2, P3, P4, ncol = 5, nrow = 1, widths = c(1.3, 1, 1, 1, 1)) 
```

The patterns for Rating are almost the same for different region sales and global sales. E is the biggest rating, then M and T, E10+ is the smallest in these four ratings. In Europe there is a little of bit of AO portion, while in Japan, some K-A games are released too.

```{r fig.width=12, fig.height=4}
par(mfrow = c(1, 2))
x <- game[,6:10]
matplot(t(x), type = "l", col = rainbow(9)[game$Rating])
legend("center", levels(game$Rating), fill = rainbow(9), cex = 0.8, pt.cex = 1)
text(c(1.2, 2, 3, 3.9, 4.8), 80000000, colnames(x))
```

There is one E game which was mainly sold in North America and Europe which was really popular and produced a sale tale of over 80 millions' global sale, while North America contributed half of the global sales. We can check the game data and know it's Wii Sports released in 2006. We also noticed that M game is popular in North America(blue), which contributed a lot to global sales, E games(green) have good sale in Europe, while Japanese like T(red) And E(green) games. It's balance in rating for "other" region.

### 5) By Rating & Genre 

```{r}
game %>%
  select(Rating, Global.Sales, Genre) %>%
  group_by(Rating, Genre) %>%
  summarise(Total.Sales = sum(Global.Sales)) %>%
  arrange(desc(Total.Sales)) %>%
ggplot(aes(x = Genre, y = Total.Sales, fill = Rating)) + 
  geom_bar(stat = "Identity") +
  theme(axis.text.x = element_text(angle = 45))
```

```{r}
library(ggmosaic)
ggplot(game) +
  geom_mosaic(aes(x = product(Rating), fill = Platform.type), na.rm=TRUE) +
  labs(x="Rating", y = "Platform Type", title="Mosaic Plot") +
  theme(axis.text.y = element_blank())
```


```{r message=FALSE, warning=FALSE, fig.width=10}
p1 <- game %>%
  select(Rating, Global.Sales, Genre, User.Score) %>%
  group_by(Rating, Genre) %>%
  summarise(Total.Sales = sum(Global.Sales), Avg.Score = mean(User.Score)) %>%
  arrange(desc(Total.Sales)) %>%
  head(20) %>%
ggplot(aes(x = Genre, y = Total.Sales, fill = Rating)) +
  geom_bar(stat = "Identity", position = "stack") +
  geom_line(aes(y = Avg.Score*10^8, group = 1), col="yellow",size = 2) +
  geom_point(aes(y = Avg.Score*10^8, col=Avg.Score*10^8),size = 3) +
  theme(axis.text.x = element_text(angle = 90),
        panel.background = element_rect(fill = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  labs(x = "Genre", y = "Global Sales", fill = "Rating") +
  scale_fill_brewer(palette = "Spectral")
p2 <- game %>%
  select(Rating, JP.Sales, Genre, User.Score) %>%
  group_by(Rating, Genre) %>%
  summarise(Total.Sales = sum(JP.Sales), Avg.Score = mean(User.Score)) %>%
  arrange(desc(Total.Sales)) %>%
  head(20) %>%
ggplot(aes(x = Genre, y = Total.Sales, fill = Rating)) +
  geom_bar(stat = "Identity",position = "stack") +
  geom_line(aes(y = Avg.Score*10^7, group = 1), col = "yellow",size = 2) +
  geom_point(aes(y = Avg.Score*10^7, col=Avg.Score*10^7),size = 3) +
  theme(axis.text.x = element_text(angle = 90),
        panel.background = element_rect(fill = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor=element_blank()) +
  labs(x = "Genre", y = "JP Sales", fill = "Rating") +
  scale_fill_brewer(palette = "Spectral")
grid.arrange(p1, p2, ncol = 2, top = "Distribution of genre and rating for top sales")
```

For the top 20 sales of genre*rating combination, same as we discussed previously, Action, Shooter and Sports have biggest Global.Sales while Role-Playing and Action are sold better in Japan. Rating M contribute big portion in both Action and Shooter global sales, Rating E sports game are popular globally. In Japan, teenage play a lot of Role-Playing games, they also play part of action and fighting games. Almost half of Japan action games are rated as M and lots of other genre games are rated as E. In both sales plots, Role-Playing games got highest average user score. 

### 6) By Platform
```{r }
library(viridis)
library(scales)
p <- game %>%
  group_by(Platform.type, Year.Release) %>%
  summarise(total = sum(Global.Sales))
  p$Year.Release. <- as.numeric(as.character(p$Year.Release))
ggplot(p, aes(x = Year.Release., fill = Platform.type)) +
  geom_density(position = "fill") +
  labs(title = "Distribution of platform type and market share by released year", y = "Market Share") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_viridis(discrete = TRUE) +
  scale_y_continuous(labels = percent_format()) 
```

Nintendo and xbox came after 1990. Before that pc and playstation occupied the game market, pc are the main  platform at that time. After 1995, the portion of pc and playstation shrinked, while nintendo and xbox grew fast and took over more portion than playstation and pc in the market. Together with Nintendo and xbox, there were other game platform sprouting out in early 1990s, but they last for 20 years and dissapeared. From around 2010, the portions of these 4 platforms keep relatively evenly and stablly.

```{r}
game %>%
  group_by(Platform.type, Critic.Score) %>%
  summarise(Total.Sales = sum(Global.Sales)) %>%
  arrange(desc(Total.Sales)) %>%
  ggplot(aes(x = Critic.Score, y = Total.Sales, group = Platform.type, fill = Platform.type)) +
  geom_bar(stat = "identity", position = "fill", alpha = 0.7) +
  scale_y_continuous(labels = percent_format()) +
  labs(title = "Distribution of platform type and market share by critical score", y = "Market Share") +
  theme(legend.position = "right", axis.text.x = element_text(angle = 90),
        panel.background = element_rect(fill = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor=element_blank())
```


*show year every 10 , sales 45 degree
```{r}
#library(ggiraph)
ggplot(game, aes(Global.Sales, Year.Release)) + 
  geom_point(aes(color = Platform.type)) + facet_grid(~ Rating) +
  ggtitle("Global Sales Vs. Year of Release by Rating") 


ggplot(game, aes(Global.Sales, Year.Release)) + 
geom_point(aes(color = Platform.type)) + facet_grid(~ Platform.type) +
  ggtitle("Global Sales Vs. Year of Release by Platform.type") 
```



```{r fig.width=12, fig.height=6}
game$Platform.type <- as.factor(game$Platform.type)
ggplot(game, aes(x = Platform.type, y = Global.Sales.Log, fill = Genre)) +
  geom_boxplot() 
```

In total, PC have lower Global sales log comparing with other platform type, while palystation have more higher sale mediums for different genre. For Xbox, Shooter is the top sale genre, puzzle is not a popular;  Misc genre contribute a lot for Nintendo, strategy is at the bottom of Nintendo sale log list. For nintendo and playstation, different genre keep balance in global sales log.  Nintendo have several real high global sales for some games.

```{r}
#compute 1-way ANOVA test forlog value of global sales by Platform Type
model <- aov(Global.Sales.Log ~ Platform.type, data = game)
summary(model)
tukey <- TukeyHSD(model)
tukey
par(mar = c(4, 10, 2, 1))
plot(tukey, las = 1)
```

ANOVA test shows that there is at lease one of the platform type is significant different from the others. The plot of Turkey tests shows that there is significant difference between all other pairs of platform types but between xbox and nintendo, others and nintendo.

##  Analysis for numeric matrix: Heatmap and PCA 
```{r  fig.width=6, fig.height=12, fig.cap='Heat map for whole game sales data set'}
library(gplots)
#require(RColorBrewer)
hclust2 <- function(x, ...)  # average linkage method
  hclust(x, method="average", ...)
dist2 <- function(x, ...)  #distance method
  as.dist(1-cor(t(x), method="pearson"))

# Transform data, standardize
st <- game[, c(11, 13, 17:23)] 
st.matrix <- as.matrix(st)
s <- apply(st.matrix, 2, function(y)(y - mean(y)) / sd(y))
a <- heatmap.2(s, 
        distfun = dist2,  # use 1-Pearson as distance
        hclustfun = hclust2,  # use average linkage
        col = greenred(75),   #color green red
        density.info = "none", # turns off density plot inside color legend
        trace = "none",  # turns off trace lines inside the heat map
        scale = "none", 
        RowSideColors = rainbow(5)[as.factor(game$Platform.type)],  
        srtCol = 45,  #column labels at 45 degree
        margins = c(8, 6), # bottom and right margins
        lhei = c(2, 10))
legend("topright", levels(as.factor(game$Platform.type)), 
       fill = rainbow(5), cex = 0.8)    # add legend 
```

The heat map clustered these columns into different groups, same as Cluster Dendrogram plot, all sales logs except JP.Sales.Log combined as one cluster, JP.Sales.Log together with tow count logs build another cluster, and two scores combined as another cluster; Also, we can find on the left side of the map, all observations are clustered into four middle clusters, then separated into two big clusters, each two middle clusters combined into one big clusters. PC and some playstation games gather together to build the second little cluster on the left bottom. 
```{r}
#rownames(st) = make.names(Name, unique=TRUE)
pca = prcomp(st, scale = T)  #scale = T to normalize the data
plot(pca)  # plot the amount of variance each principal components captures.
#str(pca)  # this shows the structure of the object, listing all parts.
summary(pca)  #shows the importance of the components
percentVar <- round(100 * summary(pca)$importance[2, 1:3], 0)  # compute % variances
percentVar
```

The first three components are 40%, 18% and 11%, together 69% of the variance. The first two components contribute 58% of the variance.
```{r}
head(pca$x) # the new coordinate values for each observation
pcaData <- as.data.frame(pca$x[, 1:2]) #First and Second principal component value
pcaData <- cbind(pcaData, game$Platform.type)  #add platform type as third col. for cluster purpose
colnames(pcaData) <- c("PC1", "PC2", "Platform")
ggplot(pcaData, aes(PC1, PC2, color = Platform, shape = Platform)) +  
  geom_point(size = 0.8) +
  xlab(paste0("PC1: ", percentVar[1], "% variance")) +  # x label
  ylab(paste0("PC2: ", percentVar[2], "% variance")) +  # y label
  ggtitle("Principal component analysis (PCA)") +  # title
  theme(aspect.ratio = 1)  # width and height ratio
```

PC, xbox, playstation and nintendo occupy in their own positions in the PCA figure, which illustrate that they play different important role in components of the variance of PC1 and PC2. 
```{r fig.cap='Kmeans figure using ggfortify'}
set.seed(123)
# Compute and plot wss for k = 2 to k = 15 to find the best k for clusters
#The elbow method looks at the percentage of variance explained as a function of the number of clusters :https://www.r-bloggers.com/finding-optimal-number-of-clusters/
#iter.max=15 to ensure the algorithm converges and nstart=50 to ensure that at least 50 random sets are choosen  
k.max <- 15
scaled_data = as.matrix(scale(st)) # Scale and center data, as matrix
wss <- sapply(1:k.max, 
              function(k){kmeans(scaled_data, k, nstart = 50, iter.max = 15 )$tot.withinss})
plot(1:k.max, wss,
     type = "b", pch = 19, frame = FALSE, 
     xlab = "Number of clusters K",
     ylab = "Total within-clusters sum of squares")

#library(mclust)
#d_clust <- Mclust(as.matrix(scaled_data), G=1:15, 
                  #modelNames = mclust.options("emModelNames"))
#d_clust$BIC
#plot(d_clust)
#library(NbClust)
#nb <- NbClust(scaled_data, diss=NULL, distance = "euclidean", 
             # min.nc=2, max.nc=5, method = "kmeans", 
              #index = "all", alphaBeale = 0.1)

library(ggfortify)
set.seed(1)
autoplot(kmeans(st, 3), data = st, label = FALSE, label.size = 0.1)
```

From the wss plot we find the best k for our data st is 2. Kmeans plot, as similar as PCA plot, explains PC1 44% and PC2 26%, altogether 66% of variance. It separate the games into two different color clusters. Each cluster is located in two different areas. This match the heat map that two middle clusters combined into one big cluster, and there are two big clusters in total.
Together with PCA figure, we will find that top of the first cluster is contributed mainly by pc, and some playstation, and a little bit of nintendo; Bottom of the first cluster is contributed mainly by xbox and platstation, and some nintendo too.
Top of second cluster is built by xbox and nintendo, there are some playstation and others platform too. Bottom of second cluster is related to nintendo, playstation and xbox evenly.


library(cluster)
autoplot(fanny(pcaData, 3), frame = TRUE)



## Models for Global Sales

Because there are two many of levels in Publisher and Developer, and there are apparent correlation between them, we use only top ten levels of Publisher and classified the other publishers as "Others"; Because of the good correlation between Critic.Score and User.Score, we use only critic score; Same reason, we will not put "other.sale.log" in our model.
```{r}
#re-categorize publisher into 13 groups
Publisher. <- head(names(sort(table(game$Publisher), decreasing = TRUE)), 12)
game <- game %>%
mutate(Publisher.type = ifelse(Publisher %in% Publisher., as.character(Publisher), "Others")) 
game.log <- game[, c(3, 11, 13, 16, 21:25, 29)]
game.log$Genre.type <- as.factor(game.log$Genre.type)
game.log$Publisher.type <- as.factor(game.log$Publisher.type)
summary(game.log)
str(game.log)
```

```{r}
model <- lm(Global.Sales.Log ~ ., data = game.log)
summary(model)
model <- aov(Global.Sales.Log ~ ., data = game.log)
summary(model)
```

Global sales is mostly effected by factors of platform type, user count log, critic score, and Publisher type in glm analysis. ANOVA shows every factors are included in the contribution, critic score and it's count log are the most important factors.

Critic score and User.Count.Log positively affect the global sales log. Platform types and publisher types either lift or pull down the global sales according to their types. This model will explain the global sales log with R-Square of 0.57.

Because of the curve smooth line at global sale ~ critic score plot in our previous analysis and its big contribution in linear model analysis, We try a polynomial fit (degree 4) of critic score only.
```{r}
model <- lm(Global.Sales.Log ~ 
           Critic.Score + I(Critic.Score^2) + I(Critic.Score^3) + I(Critic.Score^4),  data = game.log)
summary(model)
```

The first two levels are not statistically significant, we try the third and fourth levels only.
```{r fig.width=8, fig.height=8, fig.cap='Model residuals plots by plotres'}
model <- lm(Global.Sales.Log ~ I(Critic.Score^3) + I(Critic.Score^4),  data = game.log)
summary(model)
```

In total, the coefficients are statistically significant, the model of two levels of critic score itself will explain the data with R square 0.16.
```{r}
testFunc <- function(x) {model$coefficients[1] + x*x*x*model$coefficients[2] + x*x*x*x*model$coefficients[3]}
ggplot(data = game.log, aes(x = Critic.Score, y = Global.Sales.Log)) + 
  geom_point() + stat_function(fun = testFunc, color = 'blue', size = 1) + 
  xlab("Meta Critic Score") + ylab('Global Sales Log')
```

Here is the scatter plot of Global.Sales.Log ~ Critic Score and the model line which predict the global sales log.

##  Conclusion
